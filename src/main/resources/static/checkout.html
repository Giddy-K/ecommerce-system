<!DOCTYPE html>
<html>
<head>
    <title>Checkout</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h2>Checkout</h2>
        <form id="paymentForm" onsubmit="processPayment(event)">
            <div class="form-group">
                <label for="cardNumber">Card Number</label>
                <input type="text" class="form-control" id="cardNumber" required>
            </div>
            <div class="form-group">
                <label for="billingAddress">Billing Address</label>
                <input type="text" class="form-control" id="billingAddress" required>
            </div>
            <button type="submit" class="btn btn-primary">Confirm Order</button>
        </form>
    </div>

    <script>
        function getCookie(name) {
            const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            return match ? match[2] : null;
        }

        function getCartItems() {
            return JSON.parse(localStorage.getItem('cartItems')) || [];
        }

        async function processPayment(event) {
            event.preventDefault();
        
            const token = getCookie('token');
            if (!token) {
                alert("Authorization token not found.");
                return;
            }
        
            // Retrieve cart items from localStorage
            const cartItems = getCartItems();
            const orderItems = cartItems.map(item => ({
                productId: item.productId,
                quantity: item.quantity
            }));
        
            // Construct the orderRequest body as expected by the backend
            const orderRequest = {
                orderItems: orderItems
            };
        
            console.log("Order Request Payload:", JSON.stringify(orderRequest)); // Log request body
        
            try {
                const response = await fetch(`/api/users/order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${token}`
                    },
                    body: JSON.stringify(orderRequest)
                });
        
                if (response.ok) {
                    alert("Order confirmed! Thank you for your purchase.");
                    localStorage.removeItem('cartItems');  // Clear cart after placing order
                    window.location.href = 'order-history.html'; // Redirect to order history page
                } else {
                    const errorMessage = await response.text(); // Capture backend error message
                    console.error("Order error:", errorMessage); // Log the error from the backend
                    alert("Payment failed. Please check your details and try again.");
                }
            } catch (error) {
                console.error("Network or other error:", error);
                alert("An error occurred. Please try again later.");
            }
        }
        
    </script>
</body>
</html>
