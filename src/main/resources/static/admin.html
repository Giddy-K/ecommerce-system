<!DOCTYPE html>
<html>
<head>
    <title>Admin Page</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h2>Admin Dashboard</h2>
        <h3>Products</h3>
        <div id="productList" class="row"></div>
        
        <h3>Add New Product</h3>
        <form id="productForm">
            <div class="form-group">
                <label for="productName">Product Name:</label>
                <input type="text" class="form-control" id="productName" required>
            </div>
            <div class="form-group">
                <label for="productDescription">Description:</label>
                <input type="text" class="form-control" id="productDescription" required>
            </div>
            <div class="form-group">
                <label for="productPrice">Price:</label>
                <input type="number" class="form-control" id="productPrice" required>
            </div>
            <div class="form-group">
                <label for="productStock">Stock:</label>
                <input type="number" class="form-control" id="productStock" required>
            </div>
            <div class="form-group">
                <label for="productImage">Image URL:</label>
                <input type="text" class="form-control" id="productImage" required>
            </div>
            <div class="form-group">
                <label for="productCategory">Category:</label>
                <select class="form-control" id="productCategory" required></select>
            </div>
            <button type="submit" class="btn btn-primary">Add Product</button>
            <div id="authButtons" class="mb-3">
                <button id="logoutButton" class="btn btn-danger d-none">Logout</button>
            </div>
        </form>
        
    </div>

    <script>
        async function fetchCategories() {
            const response = await fetch('/api/categories');
            if (response.ok) {
                const categories = await response.json();
                const categoryDropdown = document.getElementById('productCategory');
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id; // Set the ID as the value
                    option.text = category.name; // Set the name as the display text
                    categoryDropdown.add(option);
                });
            }
        }

        async function fetchProducts() {
            const response = await fetch('/api/products');
            if (response.ok) {
                const products = await response.json();
                const productList = document.getElementById('productList');
                productList.innerHTML = '';
                products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'col-md-3';
                    productCard.innerHTML = `
                        <div class="product-card">
                            <h5>${product.name}</h5>
                            <p>${product.description}</p>
                            <p>Price: $${product.price.toFixed(2)}</p>
                            <button onclick="deleteProduct(${product.id})" class="btn btn-danger">Delete</button>
                        </div>
                    `;
                    productList.appendChild(productCard);
                });
            }
        }

        async function deleteProduct(productId) {
            await fetch(`/api/products/${productId}`, {
                method: 'DELETE'
            });
            fetchProducts(); // Refresh product list
        }

        document.getElementById('productForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const name = document.getElementById('productName').value;
            const description = document.getElementById('productDescription').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const stock = parseInt(document.getElementById('productStock').value);
            const imageUrl = document.getElementById('productImage').value;
            const categoryId = parseInt(document.getElementById('productCategory').value); // Get the category ID
        
            const productData = {
                name,
                description,
                price,
                stock,
                imageUrl,
                category: { id: categoryId }, // Correctly structured category
                rating: 9
            };
        
            try {
                const response = await fetch('/api/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(productData) // Use the productData object directly
                });
        
                if (response.ok) {
                    fetchProducts(); // Refresh product list
                    document.getElementById('productForm').reset();
                } else {
                    const error = await response.text();
                    alert(`Error: ${error}`);
                }
            } catch (error) {
                alert(`Unexpected error: ${error.message}`);
            }
        });

        document.getElementById('logoutButton').addEventListener('click', async () => {
            const response = await fetch('/api/users/logout', {
                method: 'POST',
                credentials: 'include'
            });
        
            if (response.ok) {
                document.cookie = 'JWT=; Max-Age=0; Path=/; HttpOnly;';
                window.location.reload();
            }
        });

        window.onload = () => {
            fetchCategories(); // Populate category dropdown on load
            fetchProducts();   // Populate product list on load
        };
    </script>
</body>
</html>
