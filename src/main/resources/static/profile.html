<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h2>Profile</h2>
        <form id="profileForm">
            <div class="form-group">
                <label for="name">Name:</label>
                <input type="text" class="form-control" id="name" required>
            </div>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" class="form-control" id="email" required readonly>
            </div>
            <div class="form-group">
                <label for="password">New Password (Leave blank to keep current password):</label>
                <input type="password" class="form-control" id="password">
            </div>
            <button type="submit" class="btn btn-primary">Update Profile</button>
        </form>
        <div id="message" class="mt-3"></div>
    </div>

    <script>

        function getCookie(name) {
            const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            return match ? match[2] : null;
        }
        
       // Fetch user profile
        async function fetchUserProfile() {
            const token = getCookie('token');
            if (!token) {
                console.error("Token not found");
                window.location.href = 'login.html';
                return;
            }
        
            try {
                const response = await fetch(`/api/users/me`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                if (response.ok) {
                    const user = await response.json();
                    console.log(user);
                    document.getElementById('name').value = user.name;
                    document.getElementById('email').value = user.email;
                } else {
                    console.error("Failed to fetch user info", response.statusText);
                    if (response.status === 401) {
                        window.location.href = 'login.html'; // redirect to login if unauthorized
                    }
                }
            } catch (error) {
                console.error("Error fetching user info:", error);
            }
        }

        // Handle profile update
        document.getElementById('profileForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const name = document.getElementById('name').value;
            const password = document.getElementById('password').value;
            const token = document.cookie.split('=')[1];

            const response = await fetch('/api/users/update', {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json', 
                    'Authorization': `Bearer ${token}` 
                },
                body: JSON.stringify({ name, password })
            });

            if (response.ok) {
                document.getElementById('message').textContent = 'Profile updated successfully!';
            } else {
                const error = await response.text();
                document.getElementById('message').textContent = `Error: ${error}`;
            }
        });

        window.onload = fetchUserProfile;
    </script>
</body>
</html>
