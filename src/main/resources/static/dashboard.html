<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>User Dashboard</title>
        <link rel="stylesheet"
            href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <style>
        .cart-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.8em;
        }
        .search-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin-top: 20px;
        }
        .search-input {
            width: 40%;
            max-width: 400px;
        }
        .search-icon {
            cursor: pointer;
        }
    </style>
    </head>
    <body>
        <div class="container mt-5">
            <h2>Welcome, <span id="userName"></span></h2>

            <nav class="navbar navbar-expand-lg navbar-light bg-light mt-3">
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ml-auto">
                        <li class="nav-item position-relative">
                            <a class="nav-link" href="cart.html" id="cartIcon">
                                üõí Cart
                                <span id="cartCount" class="cart-badge"></span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="profile.html">Profile</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="orders.html">My Orders</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="logoutBtn">Log
                                Out</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Search Bar -->
            <div class="search-bar">
                <input type="text" id="searchInput"
                    class="form-control search-input"
                    placeholder="Search products...">
                <span class="search-icon ml-2"
                    onclick="searchProducts()">üîç</span>
            </div>

            <div class="row mt-4">
                <div class="col-md-12">
                    <h3>Featured Products</h3>
                    <div class="row" id="productList"></div>
                </div>
            </div>
        </div>

        <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = document.cookie.split('; ').find(row => row.startsWith('token='));
            if (!token) {
                window.location.href = 'index.html';
            }
        });

        function getCookie(name) {
            const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            return match ? match[2] : null;
        }

        async function fetchUserInfo() {
            const token = getCookie('token');
            if (!token) {
                window.location.href = 'login.html'; 
                return;
            }

            try {
                const response = await fetch(`/api/users/me`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('userName').textContent = user.name;
                }
            } catch (error) {
                console.error("Error fetching user info:", error);
            }
        }

        async function fetchProducts(query = '') {
            const response = await fetch(`/api/products${query ? `/search?name=${query}` : ''}`);
            if (response.ok) {
                const products = await response.json();
                displayProducts(products);
            }
        }

        function displayProducts(products) {
            const productList = document.getElementById('productList');
            productList.innerHTML = '';
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'col-md-4 mb-4';
                productCard.innerHTML = `
                    <div class="card">
                        <img src="${product.imageUrl}" class="card-img-top" alt="${product.name}">
                        <div class="card-body">
                            <h5 class="card-title">${product.name}</h5>
                            <p class="card-text">${product.description}</p>
                            <p><strong>$${product.price}</strong></p>
                            <a href="product-details.html?id=${product.id}" class="btn btn-primary">View Product</a>
                        </div>
                    </div>
                `;
                productList.appendChild(productCard);
            });
        }

        async function fetchCartItems() {
            const token = getCookie('token');
            if (!token) return;

            try {
                const response = await fetch('/api/users/cart', {
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (response.ok) {
                    const cartItems = await response.json();
                    const cartCount = Object.keys(cartItems).length;
                    document.getElementById('cartCount').textContent = cartCount;
                }
            } catch (error) {
                console.error("Error fetching cart items:", error);
            }
        }

        function searchProducts() {
            const query = document.getElementById('searchInput').value.trim();
            if (query) {
                fetchProducts(query);
            }
        }

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('api/users/logout', {
                    method: 'POST',
                    credentials: 'include',
                });

                if (response.ok) {
                    document.cookie = 'token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC';
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error("Error logging out:", error);
            }
        });

        window.onload = () => {
            fetchUserInfo();
            fetchProducts();
            fetchCartItems();
        };

        // Trigger search on pressing Enter
        document.getElementById('searchInput').addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                searchProducts();
            }
        });
    </script>
    </body>
</html>
