<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .cart-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2>Welcome, <span id="userName"></span></h2>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item position-relative">
                        <a class="nav-link" href="cart.html" id="cartIcon">
                            ðŸ›’ Cart
                            <span id="cartCount" class="cart-badge"></span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="profile.html">Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="orders.html">My Orders</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn">Log Out</a>
                    </li>
                </ul>
            </div>
        </nav>

        <div class="row mt-4">
            <div class="col-md-12">
                <h3>Featured Products</h3>
                <div class="row" id="productList"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = document.cookie.split('; ').find(row => row.startsWith('token='));
            if (!token) {
                window.location.href = 'index.html'; // Redirect if token is not found
            }
        });

        function getCookie(name) {
            const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            return match ? match[2] : null;
        }

        async function fetchUserInfo() {
            const token = getCookie('token');
            if (!token) {
                console.error("Token not found");
                window.location.href = 'login.html'; 
                return;
            }

            try {
                const response = await fetch(`/api/users/me`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('userName').textContent = user.name;
                } else {
                    if (response.status === 401) {
                        window.location.href = 'login.html'; 
                    }
                }
            } catch (error) {
                console.error("Error fetching user info:", error);
            }
        }

        async function fetchProducts() {
            const response = await fetch('/api/products');
            if (response.ok) {
                const products = await response.json();
                const productList = document.getElementById('productList');
                
                products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'col-md-4 mb-4';  // Column layout inside the row
                    productCard.innerHTML = `
                        <div class="card">
                            <img src="${product.imageUrl}" class="card-img-top" alt="${product.name}">
                            <div class="card-body">
                                <h5 class="card-title">${product.name}</h5>
                                <p class="card-text">${product.description}</p>
                                <p><strong>$${product.price}</strong></p>
                                <a href="product-details.html?id=${product.id}" class="btn btn-primary">View Product</a>
                            </div>
                        </div>
                    `;
                    productList.appendChild(productCard);
                });
            }
        }
        

        async function fetchCartItems() {
            const token = getCookie('token');
            if (!token) return;
        
            try {
                const response = await fetch('/api/users/cart', {
                    headers: { Authorization: `Bearer ${token}` }
                });
        
                if (response.ok) {
                    const cartItems = await response.json(); // Get the cart items (Map<Long, Integer>)
                    const cartCount = Object.keys(cartItems).length; // Count the number of items in the cart
                    document.getElementById('cartCount').textContent = cartCount; // Update the cart count in UI
                } else {
                    console.error("Failed to fetch cart items");
                }
            } catch (error) {
                console.error("Error fetching cart items:", error);
            }
        }

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('api/users/logout', {
                    method: 'POST',
                    credentials: 'include', 
                });

                if (response.ok) {
                    document.cookie = 'token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC'; 
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = 'index.html';  
                } else {
                    console.error("Failed to log out from the server");
                }
            } catch (error) {
                console.error("Error logging out:", error);
            }
        });

        window.onload = () => {
            fetchUserInfo();
            fetchProducts();
            fetchCartItems();
        };
    </script>
</body>
</html>
